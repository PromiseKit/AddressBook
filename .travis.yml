branches:
  only: 
    - master
os: osx
language: objective-c
stages:
  - lint
  - test
jobs:
  include:
    - stage: lint
      matrix:
        include:
          - {osx_image: xcode8.3, env: SWIFT=3.1}
          - {osx_image: xcode9.2, env: SWIFT=3.2}
          - {osx_image: xcode9.4, env: SWIFT=3.3}
          - {osx_image: xcode10,  env: SWIFT=3.4}
          - {osx_image: xcode9.2, env: SWIFT=4.0}
          - {osx_image: xcode9.4, env: SWIFT=4.1}
          - {osx_image: xcode10,  env: SWIFT=4.2}
      cache: cocoapods
      before_install:
        gem install cocoapods --prerelease --version 1.6.0.beta.1
      install:
        carthage bootstrap --no-build PromiseKit
      script: |
        cd Carthage/Checkouts/PromiseKit
        mv .github/PromiseKit.podspec .
        rm -rf Extensions/AddressBook/Sources
        cp -R ../../../Sources Extensions/AddressBook
        pod lib lint --subspec=PromiseKit/AddressBook --fail-fast --swift-version=$SWIFT

    - stage: test
      osx_image: xcode10
      env:
        - DST='OS=12.0,name=iPhone SE' PLAT=iOS
        - DST='arch=x86_64' PLAT=macOS
      os: osx
      language: objective-c
      cache:
        directories:
        - Carthage
      before_install:
        carthage bootstrap --cache-builds --no-use-binaries --platform $PLAT
      install:
        xcodebuild -scheme PMKAddressBook -target PMKAddressBook -quiet -destination "$DST" SWIFT_TREAT_WARNINGS_AS_ERRORS=YES build
      script:
        xcodebuild -scheme PMKAddressBook -quiet -destination "$DST" test
